<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Prymis: The Clock & The Thirst v3</title>
<style>
:root{
  --deep-purple:#1a0b2e;
  --mid-purple:#2d1b4e;
  --accent-teal:#00d4aa;
  --accent-brass:#d4a574;
  --accent-glow:#8b5cf6;
  --dark-bg:#0f0a1e;
  --panel-bg:#1a1028;
  --border:#3d2966;
  --text:#e8e4f0;
  --text-dim:#9b8fb8;
  --success:#10b981;
  --warning:#f59e0b;
  --sealed:#8b0000;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',system-ui,sans-serif;background:linear-gradient(135deg,var(--deep-purple),var(--dark-bg));color:var(--text);min-height:100vh;line-height:1.6}

.header{background:var(--panel-bg);border-bottom:2px solid var(--border);padding:20px 24px;position:sticky;top:0;z-index:100}
.header h1{font-size:1.8rem;background:linear-gradient(135deg,var(--accent-brass),var(--accent-teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.header .sub{color:var(--text-dim);font-size:.9rem;font-style:italic}

.container{display:grid;grid-template-columns:1fr 1fr;gap:20px;padding:20px;max-width:1800px;margin:0 auto}
@media(max-width:1100px){.container{grid-template-columns:1fr}}

.panel{background:var(--panel-bg);border:1px solid var(--border);border-radius:12px;display:flex;flex-direction:column;overflow:hidden}
.panel-header{background:var(--mid-purple);padding:14px 20px;border-bottom:1px solid var(--border);font-weight:600;color:var(--accent-brass)}
.panel-body{padding:20px;overflow-y:auto;flex:1;max-height:calc(100vh - 160px)}

.tabs{display:flex;background:var(--deep-purple);border-bottom:1px solid var(--border);flex-wrap:wrap}
.tab{padding:10px 16px;cursor:pointer;color:var(--text-dim);border-bottom:2px solid transparent;font-size:.85rem}
.tab:hover{color:var(--accent-teal)}
.tab.active{color:var(--accent-brass);border-bottom-color:var(--accent-brass);background:var(--panel-bg)}
.tab-content{display:none;padding:20px;overflow-y:auto;max-height:calc(100vh - 220px)}
.tab-content.active{display:block}

fieldset{border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px;background:rgba(45,27,78,.3)}
legend{color:var(--accent-brass);font-weight:600;padding:0 8px;font-size:.95rem}
label{display:block;margin:8px 0;cursor:pointer}
input[type="checkbox"]{margin-right:8px;accent-color:var(--accent-teal)}
input[type="text"],input[type="number"],input[type="file"],textarea,select{width:100%;background:var(--dark-bg);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:6px;font-size:.9rem;font-family:inherit}
textarea{min-height:80px;resize:vertical;font-family:'Courier New',monospace}
textarea.large{min-height:150px}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent-teal)}
.input-group{margin:10px 0}
.input-label{display:block;color:var(--text-dim);font-size:.85rem;margin-bottom:4px}

button{padding:10px 20px;border:none;border-radius:6px;font-size:.9rem;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:linear-gradient(135deg,var(--accent-teal),#00a889);color:var(--dark-bg)}
.btn-primary:hover{transform:translateY(-1px)}
.btn-brass{background:linear-gradient(135deg,var(--accent-brass),#c99860);color:var(--dark-bg)}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-ghost:hover{background:var(--mid-purple)}
.btn-success{background:var(--success);color:white}
.btn-small{padding:6px 12px;font-size:.8rem}

.info-box{background:rgba(0,212,170,.1);border:1px solid var(--accent-teal);border-radius:8px;padding:14px;margin-bottom:16px}
.info-box.warning{background:rgba(139,0,0,.15);border-color:var(--sealed)}
.info-box h4{color:var(--accent-teal);margin-bottom:6px;font-size:.95rem}
.info-box.warning h4{color:var(--sealed)}
.info-box p{color:var(--text-dim);font-size:.85rem}

.scene-card{background:var(--dark-bg);padding:12px;margin:8px 0;border-radius:6px;border-left:3px solid var(--accent-brass)}
.scene-card.done{border-left-color:var(--success);background:rgba(16,185,129,.08)}
.scene-card.current{border-left-color:var(--accent-glow);background:rgba(139,92,246,.08)}
.scene-card.sealed{border-left-color:var(--sealed)}
.scene-title{font-weight:600;color:var(--accent-brass);font-size:.9rem}
.scene-card.done .scene-title{color:var(--success)}
.scene-card.current .scene-title{color:var(--accent-glow)}
.scene-desc{color:var(--text-dim);font-size:.8rem;margin-top:4px}
.scene-gate{font-size:.75rem;color:var(--sealed);margin-top:4px}

.state-box{background:var(--dark-bg);border:1px solid var(--border);border-radius:8px;padding:14px;margin:12px 0}
.state-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)}
.state-row:last-child{border-bottom:none}
.state-label{color:var(--text-dim);font-size:.85rem}
.state-value{color:var(--accent-teal);font-size:.85rem}
.tag{display:inline-block;background:var(--mid-purple);padding:2px 8px;border-radius:10px;font-size:.75rem;margin:2px}
.tag.done{background:rgba(16,185,129,.2);color:var(--success)}

.progress{background:var(--dark-bg);height:6px;border-radius:3px;overflow:hidden;margin:8px 0}
.progress-fill{background:linear-gradient(90deg,var(--accent-brass),var(--success));height:100%;transition:width .3s}

.output-area{background:var(--dark-bg);border:1px solid var(--border);border-radius:8px;padding:16px;min-height:300px;max-height:500px;overflow-y:auto;font-family:'Courier New',monospace;font-size:.85rem;white-space:pre-wrap;color:var(--accent-teal)}

.ai-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-top:12px}
.ai-btn{padding:8px 12px;font-size:.8rem;background:var(--mid-purple);border:1px solid var(--border);color:var(--text);border-radius:6px;cursor:pointer}
.ai-btn:hover{background:var(--accent-glow);border-color:var(--accent-teal)}

.illust-item{background:var(--dark-bg);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:14px}
.illust-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.illust-title{font-weight:600;color:var(--accent-brass);font-size:.9rem}
.illust-badge{font-size:.75rem;padding:2px 8px;border-radius:10px}
.illust-badge.has{background:rgba(16,185,129,.2);color:var(--success)}
.illust-badge.none{background:rgba(155,144,128,.2);color:var(--text-dim)}
.illust-prompt{background:rgba(45,27,78,.5);padding:8px;border-radius:4px;font-size:.8rem;color:var(--text-dim);margin-bottom:10px;font-family:'Courier New',monospace}
.illust-actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.illust-preview{max-width:100%;max-height:200px;border-radius:6px;border:2px solid var(--border);margin-top:10px;display:none}
.illust-preview.visible{display:block}
.file-input-wrap{display:block;cursor:pointer}
.file-input-wrap input[type="file"]{position:absolute;width:1px;height:1px;opacity:0;overflow:hidden}
.file-input-label{display:block;padding:10px;background:var(--mid-purple);border:2px dashed var(--border);border-radius:6px;text-align:center;color:var(--text-dim);font-size:.85rem;cursor:pointer;transition:all .2s}
.file-input-wrap:hover .file-input-label{border-color:var(--accent-teal);background:rgba(0,212,170,.05)}

.download-box{background:rgba(16,185,129,.1);border:1px solid var(--success);border-radius:8px;padding:16px;margin-top:16px}
.download-box h4{color:var(--success);margin-bottom:10px}
.download-actions{display:flex;gap:10px;flex-wrap:wrap}

.toast{position:fixed;bottom:20px;right:20px;background:var(--success);color:white;padding:12px 20px;border-radius:6px;opacity:0;transform:translateY(50px);transition:all .3s;z-index:200;font-weight:600}
.toast.show{opacity:1;transform:translateY(0)}
</style>
</head>
<body>
<div class="header">
  <h1>‚öôÔ∏è THE CLOCK & THE THIRST</h1>
  <div class="sub">Victorian Steampunk Mystery ‚Äî v3: Know Everything, Reveal Nothing</div>
</div>

<div class="container">
  <!-- LEFT PANEL -->
  <div class="panel">
    <div class="tabs">
      <div class="tab active" data-tab="continue">üìú Continue</div>
      <div class="tab" data-tab="scenes">Scenes</div>
      <div class="tab" data-tab="characters">Characters</div>
      <div class="tab" data-tab="illustrations">üé® Art</div>
      <div class="tab" data-tab="solution">üîí Solution</div>
      <div class="tab" data-tab="settings">Settings</div>
    </div>

    <!-- Continue Tab -->
    <div class="tab-content active" data-content="continue">
      <div class="info-box">
        <h4>‚öôÔ∏è v3: Know Everything, Reveal Nothing</h4>
        <p>The AI gets the full solution every time, but with explicit instructions on what NOT to reveal yet. Pacing > secrecy.</p>
      </div>

      <fieldset>
        <legend>üìä Case Status</legend>
        <div class="progress"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
        <div class="state-box">
          <div class="state-row"><span class="state-label">Progress</span><span class="state-value" id="progress-text">0/9 scenes</span></div>
          <div class="state-row"><span class="state-label">Current Scene</span><span class="state-value" id="current-scene">fog_night</span></div>
          <div class="state-row"><span class="state-label">Method Gate</span><span class="state-value" id="gate-status">üîí Locked</span></div>
          <div class="state-row"><span class="state-label">Word Count</span><span class="state-value" id="word-count">0</span></div>
        </div>
        <div id="completed-tags" style="margin-top:8px"></div>
      </fieldset>

      <fieldset>
        <legend>üì• Paste AI Output</legend>
        <textarea id="ai-paste" class="large" placeholder="Paste the AI's output here (prose + state markers)..."></textarea>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button class="btn-success" id="parse-btn">üîç Parse & Update</button>
          <button class="btn-ghost btn-small" id="clear-btn">Clear Case</button>
        </div>
      </fieldset>

      <fieldset>
        <legend>üìñ Story So Far</legend>
        <textarea id="prose" class="large" placeholder="Accumulated prose appears here..."></textarea>
      </fieldset>
    </div>

    <!-- Scenes Tab -->
    <div class="tab-content" data-content="scenes">
      <div class="info-box">
        <h4>Scene Progression</h4>
        <p>Each scene has REVELATION GATES ‚Äî what the reader should NOT know yet.</p>
      </div>
      <div id="scene-list"></div>
    </div>

    <!-- Characters Tab -->
    <div class="tab-content" data-content="characters">
      <div id="char-list"></div>
    </div>

    <!-- Illustrations Tab -->
    <div class="tab-content" data-content="illustrations">
      <fieldset>
        <legend>üé® Global Art Style</legend>
        <textarea id="art-style" class="small">Victorian steampunk aesthetic. Gaslight and brass. Fog, dark wood, clockwork. Vicky: porcelain face, brass joints, glass eyes with faint inner glow. The Detective: gaunt, precise, pocket metronome. Muted palette with teal and amber accents. Cinematic 3:2 aspect.</textarea>
      </fieldset>
      <div id="illust-list"></div>
      <div class="download-box">
        <h4>üì• Download Story</h4>
        <div class="download-actions">
          <button class="btn-success" id="download-html">Download HTML</button>
          <button class="btn-brass" id="download-md">Download Markdown</button>
        </div>
      </div>
    </div>

    <!-- Solution Tab -->
    <div class="tab-content" data-content="solution">
      <div class="info-box warning">
        <h4>‚ö†Ô∏è FULL SOLUTION ‚Äî SPOILERS</h4>
        <p>This is included in EVERY prompt. The AI knows. It just can't tell yet.</p>
      </div>
      <fieldset>
        <legend>The Method</legend>
        <textarea id="sol-method">LOCKED ROOM METHOD:
Simon Vale shot himself with his own silent railgun prototype.
After his death, his secretary Mr. Ash staged the locked room:
‚Ä¢ A magnet on a string, pulled through the speaking tube from the back parlor
‚Ä¢ The magnet slid the crossbar bolt shut from outside
‚Ä¢ The magnet was withdrawn; residual magnetization remains on the bolt
‚Ä¢ The string left rosin dust in the tube cap

PROOFS:
‚Ä¢ Compass leans at the bolt (residual magnetism)
‚Ä¢ Iron filings make a fern pattern pointing to the speaking tube
‚Ä¢ Black enamel flake from the magnet
‚Ä¢ Rosin dust in the tube cap</textarea>
      </fieldset>
      <fieldset>
        <legend>The Motive</legend>
        <textarea id="sol-motive">Simon Vale was dying. His weapons work (the silent railgun) would profit the wrong people.
He chose to end it on his own terms, but needed it to look like murder to void the insurance and stop the profit machine.
Ash helped because he believed in civic calm ‚Äî protecting the city from scandal.

VERDICT: Suicide with accomplice. Secretary staged the lock at victim's request.</textarea>
      </fieldset>
      <fieldset>
        <legend>The "Din" Revelation</legend>
        <textarea id="sol-din">The note on the desk said "noise" ‚Äî but Eleanor insists Simon always wrote "din."
Ash wrote the note. This is the widow's proof that something was staged.
"Din, not noise" is the truth she keeps.</textarea>
      </fieldset>
      <fieldset>
        <legend>Vicky's Arc</legend>
        <textarea id="sol-vicky">Vicky's rules: Mind your crown (2nd blow changes tuning), never drink, shun magnets.
The speaking tube method terrifies her ‚Äî magnets could harm her.
Spirit photographs show her with a blank center ‚Äî no aura.
Her question: Does she have a soul? Is "spirit = thirst" enough?
By the end: she returns to her journals on cells, still wondering, but accepted.</textarea>
      </fieldset>
    </div>

    <!-- Settings Tab -->
    <div class="tab-content" data-content="settings">
      <fieldset>
        <legend>Output Settings</legend>
        <div class="input-group">
          <label class="input-label">Target Word Count</label>
          <input type="number" id="target-words" value="2000" min="500" max="8000" step="100">
        </div>
        <div class="input-group">
          <label class="input-label">Style Notes</label>
          <textarea id="style-notes" placeholder="Additional style guidance..."></textarea>
        </div>
      </fieldset>
      <fieldset>
        <legend>Base Prompt</legend>
        <textarea id="base-prompt" class="large">You are writing a Victorian steampunk detective mystery. "The Clock & The Thirst."

LOGLINE: Late-Victorian London. A methodical, dying detective and Vicky ‚Äî a delicate, over-feeling steampunk android who does not drink ‚Äî investigate an "impossible" death: a politician found in a bolted study with a silent railgun. S√©ances, speaking tubes, magnets, and a museum manuscript point to a staged room ‚Äî and to the larger question of what counts as a soul.

WRITING STYLE:
‚Ä¢ Precise, spare prose ‚Äî plainness over purple
‚Ä¢ One strong sensory detail per beat
‚Ä¢ Short actions, occasional inner line, then move
‚Ä¢ Show respect: Vicky's personhood and the Detective's neurodivergence are strengths
‚Ä¢ Let props do the poetry: the metronome, the speaking tube, the compass
‚Ä¢ Vicky's inner voice: anxious, tender, curious about cells and souls</textarea>
      </fieldset>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="panel">
    <div class="panel-header">Generated Prompt</div>
    <div class="panel-body">
      <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
        <button class="btn-primary" id="generate-btn">‚öôÔ∏è Generate Prompt</button>
        <button class="btn-brass" id="copy-btn">üìã Copy</button>
      </div>
      <div class="output-area" id="output"><span style="color:var(--text-dim);font-style:italic">Configure and generate...

KEY INSIGHT: The AI knows the full solution.
It just has strict orders on what NOT to reveal yet.

Scene 1-2: Don't mention the method or Ash's role
Scene 3-4: Plant clues but don't connect them
Scene 5: Reveal the METHOD (magnet trick)
Scene 6-7: Build toward confrontation
Scene 8+: Full revelation ‚Äî Ash confesses</span></div>
      <fieldset style="margin-top:16px">
        <legend>Launch</legend>
        <div class="ai-grid">
          <button class="ai-btn" data-ai="claude">Claude</button>
          <button class="ai-btn" data-ai="gpt">GPT-4</button>
          <button class="ai-btn" data-ai="gemini">Gemini</button>
          <button class="ai-btn" data-ai="deepseek">DeepSeek</button>
        </div>
      </fieldset>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
'use strict';

// ============================================
// DATA
// ============================================

const SCENES = {
  fog_night: {
    order: 1,
    title: 'Opening ‚Äî Fog Row Station',
    desc: 'Introduce Vicky and the Detective at their cramped outpost. His methodical silence, her anxious inner monologue. The pocket metronome. Her fascination with Royal Society journals on cells. A quiet moment before the case arrives.',
    gates: ['Do NOT mention the locked room method', 'Do NOT hint at Ash\'s role', 'Do NOT mention magnets as threat yet'],
    artPrompt: 'Victorian detective office at night, gaslight, fog outside window, clockwork android woman reading by lamplight, gaunt detective with metronome, brass and dark wood, steampunk aesthetic'
  },
  arrival: {
    order: 2,
    title: 'Eleanor Arrives ‚Äî The Widow',
    desc: 'Eleanor Vale knocks. Steel-calm but determined. Her husband found dead in his locked study. She needs answers, not comfort. Vicky observes her certainty that something is wrong.',
    gates: ['Do NOT mention the method', 'Do NOT reveal "din vs noise" yet', 'Do NOT hint at Ash'],
    artPrompt: 'Victorian widow in black at doorway, gaslight behind her, fog, steampunk detective office interior, android and detective receiving her'
  },
  study_initial: {
    order: 3,
    title: 'Vale Study ‚Äî Initial Investigation',
    desc: 'First examination of the locked room. Crossbar bolt slid from inside, window untouched. Body with the silent railgun. A note on the desk. The impossible nature of the scene.',
    gates: ['Describe clues but do NOT connect them yet', 'Do NOT explain the speaking tube significance', 'Can mention the note exists, not its content discrepancy'],
    artPrompt: 'Victorian study crime scene, locked door with heavy bolt, body silhouette, strange weapon on floor, detective examining with magnifying glass, android observing, dim gaslight'
  },
  seance: {
    order: 4,
    title: 'Vale House ‚Äî The S√©ance',
    desc: 'Eleanor hosts a s√©ance. "Sherry to tea to Vicky: I do not drink." Spirit photographs taken. Ouija writes a word. The compass behaves strangely near the speaking tube. Vicky flinches ‚Äî magnets.',
    gates: ['NOW plant the compass clue (strange behavior)', 'NOW show Vicky\'s fear of magnets', 'Do NOT yet explain WHY the compass reacts', 'Can show "din" on Ouija if desired'],
    artPrompt: 'Victorian s√©ance scene, round table, candles, medium, widow in black, spirit photographer with flash, android flinching, brass speaking tube on wall, eerie atmosphere'
  },
  proof: {
    order: 5,
    title: 'Vale Study ‚Äî Forensic Proof',
    desc: 'Daylight return. Compass lean at the bolt. Iron filings make a fern pattern. Black enamel flake. Rosin dust in the tube cap. Demonstration: a magnet on string through the tube pulls the bolt.',
    gates: ['NOW reveal the METHOD completely', 'Show how the locked room was staged', 'Do NOT yet reveal WHO did it or WHY'],
    revelation: true,
    artPrompt: 'Victorian study daylight, detective demonstrating with magnet on string through brass speaking tube, iron filings pattern on floor, android watching intently, forensic evidence'
  },
  museum: {
    order: 6,
    title: 'Royal Museum ‚Äî MS 4178',
    desc: 'Investigating Simon\'s background. The weapons collection. MS 4178: ancient manuscript about vibrating couplers ‚Äî Vicky\'s principle. A map leaf has been cut out. Penhaligon confirms the access log.',
    gates: ['Build mystery around who accessed the manuscript', 'Connect to Vicky\'s origins if desired', 'Do NOT yet name Ash as the one who cut the page'],
    artPrompt: 'Victorian museum archive, ancient manuscript under glass, firearms collection, female curator, android examining with wonder, detective checking ledger'
  },
  aether_arrive: {
    order: 7,
    title: 'Fog Row ‚Äî The Aether Men',
    desc: 'The Aether Collegium appears. Dr. Voss (velvet authority), Mr. Sykes (coils), Mr. Finn (eager). They want Vicky\'s principle. Magnets surrendered. Boundaries tested. The Detective protects her.',
    gates: ['Show threat to Vicky from those who want her secrets', 'Build tension', 'Do NOT yet connect to the main mystery resolution'],
    artPrompt: 'Victorian office confrontation, three sinister scientists with electrical equipment, android backed against wall, detective standing protective, brass coils and equipment, tense atmosphere'
  },
  confrontation: {
    order: 8,
    title: 'Confrontation ‚Äî Ash Confesses',
    desc: 'The truth emerges. Ash admits his role. Simon fired the weapon himself. Ash staged the locked room. The word was changed. Why: to void insurance, protect the city, stop the profit machine. Suicide with accomplice.',
    gates: ['FULL REVELATION NOW', 'Ash confesses everything', 'Explain motive completely', 'The "din not noise" proof'],
    revelation: true,
    artPrompt: 'Victorian office, secretary confessing, widow listening stoic, detective and android present, emotional tension, gaslight shadows, moment of truth'
  },
  coda: {
    order: 9,
    title: 'Coda ‚Äî Plain Ledger and Whisper',
    desc: 'Report filed: self-inflicted, lock staged. Eleanor keeps her truth ‚Äî the word that mattered. A quiet moment between Vicky and the Detective. "Calm without truth is quiet harm." Vicky returns to her journals, still wondering about souls.',
    gates: ['Resolution and peace', 'Vicky\'s ongoing question remains open', 'The Detective\'s quiet acceptance'],
    revelation: true,
    artPrompt: 'Victorian office at dawn, android reading journal about cells, detective writing report, peaceful resolution, soft light, pocket metronome on desk'
  }
};

const CHARACTERS = {
  vicky: {
    name: 'VICKY (android detective assistant)',
    desc: 'Steampunk android built by anonymous clockmaker using vibrating coupler (novel gearwork + resonating crystals). Reads Royal Society papers obsessively; fascinated by cells ("spirit = thirst"). Rules from maker: mind your crown (2nd head blow alters tuning); never drink; shun magnets. Can be utterly still (no breath/pulse); perfect recall; tender curiosity. Aura plates show blank center; she longs anyway.'
  },
  detective: {
    name: 'THE DETECTIVE (human, methodical, dying quietly)',
    desc: 'Precise, spare; keeps time with a pocket metronome; slightly on spectrum, coughs blood, denies it. Drafted Vicky after seeing her exonerate a dockhand as Mechanical Witness. Wrote Fog Row No Disassembly Clause. Belief: proof is love; names things plainly; protects Vicky.'
  },
  eleanor: {
    name: 'ELEANOR VALE (widow)',
    desc: 'Steel-calm; knows her husband\'s voice and hand. Hosts the post-mortem s√©ance. Refuses tidy lies. Keeps the word DIN as the true memorial.'
  },
  ash: {
    name: 'MR. ASH (private secretary; accomplice)',
    desc: 'Precise, devout believer in civic calm. Learned the magnet-through-tube trick; wrote the word "noise." Cut a map leaf from the museum manuscript.'
  },
  corvina: {
    name: 'MADAME CORVINA (medium)',
    desc: 'Showwoman with a grain of real; tells Vicky: Spirit is thirst. Leaving for Paris.'
  },
  helt: {
    name: 'MR. HELT (spirit photographer)',
    desc: 'Tinkerer; his plates show Vicky blank center. Exposure problems at edges due to her metal/ceramic nature.'
  },
  penhaligon: {
    name: 'ADA PENHALIGON (Museum Keeper)',
    desc: 'Dry, ethical; ally. Confirms access logs and protects the collections.'
  },
  aether: {
    name: 'AETHER COLLEGIUM',
    desc: 'Dr. Voss (velvet authority), Mr. Sykes (coils and filings), Mr. Finn (eager junior). Want Vicky\'s principle and pieces. Boundaries only under pressure.'
  }
};

const DEFAULT_STATE = {
  completed: [],
  current: 'fog_night',
  summary: '',
  words: 0,
  iteration: 0
};

// Storage
function load(k, def) {
  const s = localStorage.getItem('clockthirst3_' + k);
  return s ? JSON.parse(s) : JSON.parse(JSON.stringify(def));
}
function save(k, v) { 
  try {
    localStorage.setItem('clockthirst3_' + k, JSON.stringify(v)); 
  } catch (e) {
    console.error('Save failed:', e);
  }
}

// IndexedDB for images
const ImageDB = {
  db: null,
  
  async init() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open('clockthirst_images', 1);
      req.onerror = () => reject(req.error);
      req.onsuccess = () => { this.db = req.result; resolve(); };
      req.onupgradeneeded = (e) => {
        e.target.result.createObjectStore('images', { keyPath: 'scene' });
      };
    });
  },
  
  async get(scene) {
    if (!this.db) await this.init();
    return new Promise((resolve) => {
      const tx = this.db.transaction('images', 'readonly');
      const req = tx.objectStore('images').get(scene);
      req.onsuccess = () => resolve(req.result?.data || null);
      req.onerror = () => resolve(null);
    });
  },
  
  async set(scene, data) {
    if (!this.db) await this.init();
    return new Promise((resolve) => {
      const tx = this.db.transaction('images', 'readwrite');
      tx.objectStore('images').put({ scene, data });
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => resolve(false);
    });
  },
  
  async delete(scene) {
    if (!this.db) await this.init();
    return new Promise((resolve) => {
      const tx = this.db.transaction('images', 'readwrite');
      tx.objectStore('images').delete(scene);
      tx.oncomplete = () => resolve(true);
    });
  },
  
  async getAll() {
    if (!this.db) await this.init();
    return new Promise((resolve) => {
      const tx = this.db.transaction('images', 'readonly');
      const req = tx.objectStore('images').getAll();
      req.onsuccess = () => {
        const map = {};
        req.result.forEach(r => map[r.scene] = r.data);
        resolve(map);
      };
      req.onerror = () => resolve({});
    });
  },
  
  async clear() {
    if (!this.db) await this.init();
    return new Promise((resolve) => {
      const tx = this.db.transaction('images', 'readwrite');
      tx.objectStore('images').clear();
      tx.oncomplete = () => resolve(true);
    });
  }
};

let STATE = load('state', DEFAULT_STATE);
let IMAGES = {};
let currentPrompt = '';

// ============================================
// HELPERS
// ============================================

function isMethodRevealed() {
  return STATE.completed.includes('proof');
}

function getNextScene() {
  const order = Object.keys(SCENES).sort((a,b) => SCENES[a].order - SCENES[b].order);
  return order.find(s => !STATE.completed.includes(s)) || null;
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function compressImage(file, maxWidth = 800, quality = 0.7) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;
        if (w > maxWidth) {
          h = Math.round(h * maxWidth / w);
          w = maxWidth;
        }
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// ============================================
// UI BUILDERS
// ============================================

function buildSceneList() {
  const el = document.getElementById('scene-list');
  const order = Object.keys(SCENES).sort((a,b) => SCENES[a].order - SCENES[b].order);
  
  el.innerHTML = order.map(key => {
    const s = SCENES[key];
    const done = STATE.completed.includes(key);
    const current = STATE.current === key;
    let cls = 'scene-card';
    if (done) cls += ' done';
    else if (current) cls += ' current';
    else if (s.revelation && !isMethodRevealed()) cls += ' sealed';
    
    return `<div class="${cls}">
      <div class="scene-title">${done ? '‚úì ' : current ? '‚ñ∫ ' : ''}${s.title}</div>
      <div class="scene-desc">${s.desc}</div>
      <div class="scene-gate"><strong>Gates:</strong> ${s.gates.join(' ‚Ä¢ ')}</div>
    </div>`;
  }).join('');
}

function buildCharList() {
  const el = document.getElementById('char-list');
  el.innerHTML = Object.keys(CHARACTERS).map(key => {
    const c = CHARACTERS[key];
    return `<div class="scene-card">
      <div class="scene-title">${c.name}</div>
      <div class="scene-desc">${c.desc}</div>
    </div>`;
  }).join('');
}

function buildIllustList() {
  const el = document.getElementById('illust-list');
  const order = Object.keys(SCENES).sort((a,b) => SCENES[a].order - SCENES[b].order);
  
  el.innerHTML = order.map(key => {
    const s = SCENES[key];
    const hasImg = IMAGES[key];
    
    return `<div class="illust-item" data-scene="${key}">
      <div class="illust-header">
        <span class="illust-title">${s.title}</span>
        <span class="illust-badge ${hasImg ? 'has' : 'none'}">${hasImg ? '‚úì Image' : 'No image'}</span>
      </div>
      <div class="illust-prompt">${s.artPrompt}</div>
      <div class="illust-actions">
        <button class="btn-ghost btn-small copy-prompt" data-scene="${key}">üìã Copy</button>
        <button class="btn-ghost btn-small copy-full" data-scene="${key}">üìã + Style</button>
        ${hasImg ? `<button class="btn-ghost btn-small clear-img" data-scene="${key}">‚úï Clear</button>` : ''}
      </div>
      <label class="file-input-wrap">
        <input type="file" accept="image/*" class="img-upload" data-scene="${key}">
        <span class="file-input-label">üìé Click to upload image or drag file here</span>
      </label>
      <img class="illust-preview ${hasImg ? 'visible' : ''}" src="${hasImg || ''}" data-scene="${key}">
    </div>`;
  }).join('');
  
  // Events
  el.querySelectorAll('.copy-prompt').forEach(btn => {
    btn.onclick = () => {
      navigator.clipboard.writeText(SCENES[btn.dataset.scene].artPrompt);
      toast('Prompt copied');
    };
  });
  
  el.querySelectorAll('.copy-full').forEach(btn => {
    btn.onclick = () => {
      const style = document.getElementById('art-style').value;
      const prompt = style + '\n\nScene: ' + SCENES[btn.dataset.scene].artPrompt;
      navigator.clipboard.writeText(prompt);
      toast('Full prompt copied');
    };
  });
  
  el.querySelectorAll('.clear-img').forEach(btn => {
    btn.onclick = async () => {
      delete IMAGES[btn.dataset.scene];
      await ImageDB.delete(btn.dataset.scene);
      buildIllustList();
      toast('Image cleared');
    };
  });
  
  el.querySelectorAll('.img-upload').forEach(inp => {
    inp.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      toast('Processing...');
      const compressed = await compressImage(file);
      IMAGES[inp.dataset.scene] = compressed;
      await ImageDB.set(inp.dataset.scene, compressed);
      buildIllustList();
      toast('Image added');
    };
  });
  
  // Drag and drop
  el.querySelectorAll('.file-input-wrap').forEach(wrap => {
    const scene = wrap.querySelector('.img-upload').dataset.scene;
    
    wrap.ondragover = (e) => {
      e.preventDefault();
      wrap.querySelector('.file-input-label').style.borderColor = 'var(--accent-teal)';
      wrap.querySelector('.file-input-label').style.background = 'rgba(0,212,170,.15)';
    };
    
    wrap.ondragleave = () => {
      wrap.querySelector('.file-input-label').style.borderColor = '';
      wrap.querySelector('.file-input-label').style.background = '';
    };
    
    wrap.ondrop = async (e) => {
      e.preventDefault();
      wrap.querySelector('.file-input-label').style.borderColor = '';
      wrap.querySelector('.file-input-label').style.background = '';
      
      const file = e.dataTransfer.files[0];
      if (!file || !file.type.startsWith('image/')) return;
      
      toast('Processing...');
      const compressed = await compressImage(file);
      IMAGES[scene] = compressed;
      await ImageDB.set(scene, compressed);
      buildIllustList();
      toast('Image added');
    };
  });
}

function updateUI() {
  const total = Object.keys(SCENES).length;
  const done = STATE.completed.length;
  const pct = Math.round((done / total) * 100);
  
  document.getElementById('progress-fill').style.width = pct + '%';
  document.getElementById('progress-text').textContent = `${done}/${total} scenes`;
  document.getElementById('current-scene').textContent = STATE.current || 'Complete';
  document.getElementById('gate-status').textContent = isMethodRevealed() ? 'üîì Method Revealed' : 'üîí Method Hidden';
  document.getElementById('word-count').textContent = STATE.words.toLocaleString();
  
  const tags = document.getElementById('completed-tags');
  tags.innerHTML = STATE.completed.map(s => 
    `<span class="tag done">${SCENES[s]?.title.split('‚Äî')[0].trim() || s}</span>`
  ).join('') || '<span style="color:var(--text-dim);font-size:.85rem">No scenes completed</span>';
  
  const proseEl = document.getElementById('prose');
  const saved = localStorage.getItem('clockthirst3_prose') || '';
  if (saved && !proseEl.value) proseEl.value = saved;
  
  buildSceneList();
}

// ============================================
// PARSING
// ============================================

function parseOutput() {
  const raw = document.getElementById('ai-paste').value.trim();
  if (!raw) { alert('Paste output first'); return; }
  
  let prose = raw;
  
  const markers = {};
  const markerRegex = /\[([A-Z_]+):\s*([^\]]+)\]/gi;
  let match;
  while ((match = markerRegex.exec(raw)) !== null) {
    markers[match[1].toLowerCase()] = match[2].trim();
  }
  
  prose = raw.replace(markerRegex, '').trim();
  
  // JSON fallback
  const jsonMatch = raw.match(/```json\s*([\s\S]*?)\s*```/);
  if (jsonMatch) {
    try {
      const parsed = JSON.parse(jsonMatch[1]);
      const state = parsed.story_state || parsed;
      if (state.completed_scenes) {
        state.completed_scenes.forEach(s => {
          if (!STATE.completed.includes(s)) STATE.completed.push(s);
        });
      }
      if (state.next_scene) STATE.current = state.next_scene;
      if (state.summary) STATE.summary = state.summary;
      if (state.word_count_this_segment) STATE.words += state.word_count_this_segment;
    } catch(e) { console.log('JSON parse failed, using markers'); }
    prose = raw.replace(/```json\s*[\s\S]*?\s*```/, '').trim();
  }
  
  // Apply markers
  if (markers.scene_complete || markers.completed) {
    const scene = markers.scene_complete || markers.completed;
    scene.split(',').map(s => s.trim()).forEach(s => {
      if (s && SCENES[s] && !STATE.completed.includes(s)) STATE.completed.push(s);
    });
  }
  if (markers.next) STATE.current = markers.next.trim();
  if (markers.summary) STATE.summary = markers.summary;
  if (markers.words) STATE.words += parseInt(markers.words) || 0;
  
  if (!markers.next && !STATE.current) {
    STATE.current = getNextScene();
  }
  
  if (!markers.words) {
    STATE.words += prose.split(/\s+/).filter(w => w).length;
  }
  
  STATE.iteration++;
  save('state', STATE);
  
  const proseEl = document.getElementById('prose');
  const existing = proseEl.value.trim();
  proseEl.value = existing + (existing ? '\n\n---\n\n' : '') + prose;
  localStorage.setItem('clockthirst3_prose', proseEl.value);
  
  document.getElementById('ai-paste').value = '';
  updateUI();
  toast('‚úì State updated');
}

function clearCase() {
  if (!confirm('Clear all progress?')) return;
  STATE = JSON.parse(JSON.stringify(DEFAULT_STATE));
  IMAGES = {};
  save('state', STATE);
  ImageDB.clear();
  localStorage.setItem('clockthirst3_prose', '');
  document.getElementById('prose').value = '';
  document.getElementById('ai-paste').value = '';
  updateUI();
  buildIllustList();
  toast('Case cleared');
}

// ============================================
// PROMPT GENERATION
// ============================================

function generatePrompt() {
  const base = document.getElementById('base-prompt').value;
  const targetWords = document.getElementById('target-words').value;
  const styleNotes = document.getElementById('style-notes').value;
  const prose = document.getElementById('prose').value.trim();
  
  const currentScene = STATE.current || getNextScene();
  const scene = SCENES[currentScene];
  const isContinuation = STATE.completed.length > 0;
  
  let prompt = base + '\n\n';
  
  // ========== FULL SOLUTION (ALWAYS) ==========
  prompt += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
THE SOLUTION (You know this. The reader doesn't. Yet.)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${document.getElementById('sol-method').value}

MOTIVE:
${document.getElementById('sol-motive').value}

THE "DIN" REVELATION:
${document.getElementById('sol-din').value}

VICKY'S ARC:
${document.getElementById('sol-vicky').value}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

`;

  // ========== REVELATION GATES ==========
  prompt += `REVELATION GATES ‚Äî What the reader knows so far:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

`;

  const order = Object.keys(SCENES).sort((a,b) => SCENES[a].order - SCENES[b].order);
  order.forEach(key => {
    const s = SCENES[key];
    const done = STATE.completed.includes(key);
    const current = key === currentScene;
    
    let status = done ? '‚úì DONE' : current ? '‚ñ∫ CURRENT' : '‚óã PENDING';
    prompt += `${status} ‚Äî ${s.title}\n`;
    
    if (current || done) {
      s.gates.forEach(g => prompt += `   ${done ? '(revealed)' : '‚ö†Ô∏è ' + g}\n`);
    }
  });

  prompt += `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

`;

  // ========== CONTINUATION CONTEXT ==========
  if (isContinuation) {
    prompt += `STORY CONTINUATION (Iteration ${STATE.iteration + 1})
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

COMPLETED: ${STATE.completed.map(s => SCENES[s]?.title.split('‚Äî')[0].trim()).join(', ')}

SUMMARY: ${STATE.summary || 'No summary yet'}

`;
    if (prose.length > 0 && prose.length < 4000) {
      prompt += `STORY SO FAR:\n${prose}\n\n`;
    } else if (prose.length >= 4000) {
      prompt += `RECENT (excerpt):\n...${prose.slice(-2500)}\n\n`;
    }
  }

  // ========== CURRENT SCENE ==========
  if (scene) {
    prompt += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
WRITE THIS SCENE: ${scene.title}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${scene.desc}

‚ö†Ô∏è GATES FOR THIS SCENE:
${scene.gates.map(g => '‚Ä¢ ' + g).join('\n')}

`;
  }

  // ========== CHARACTERS ==========
  prompt += `CHARACTERS:
`;
  Object.keys(CHARACTERS).forEach(key => {
    const c = CHARACTERS[key];
    prompt += `\n${c.name}\n${c.desc}\n`;
  });

  // ========== OUTPUT FORMAT ==========
  prompt += `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
OUTPUT FORMAT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Target: ~${targetWords} words

After your prose, add these markers on their own lines:

[SCENE_COMPLETE: ${currentScene}]
[NEXT: ${getNextScene() || 'complete'}]
[SUMMARY: 2-3 sentence summary of what happened]
[WORDS: approximate word count]

Scene keys: fog_night, arrival, study_initial, seance, proof, museum, aether_arrive, confrontation, coda

`;

  if (styleNotes) {
    prompt += `STYLE NOTES: ${styleNotes}\n\n`;
  }

  prompt += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Begin. Remember: you KNOW the solution. You cannot TELL it yet.
Write to the gates.`;

  currentPrompt = prompt;
  document.getElementById('output').textContent = prompt;
}

// ============================================
// DOWNLOADS
// ============================================

function downloadHTML() {
  const prose = document.getElementById('prose').value;
  const sections = prose.split(/\n---\n/).filter(p => p.trim());
  
  let html = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>The Clock & The Thirst</title>
<style>
body{font-family:Georgia,serif;max-width:750px;margin:40px auto;padding:20px;background:#1a0b2e;color:#e8e4f0;line-height:1.8}
h1{color:#d4a574;text-align:center;border-bottom:2px solid #3d2966;padding-bottom:20px}
h2{color:#00d4aa;margin-top:40px}
.img{max-width:100%;border-radius:8px;margin:20px 0}
p{text-indent:2em;margin:1em 0}
hr{border:none;border-top:1px solid #3d2966;margin:40px 0}
</style></head><body>
<h1>‚öôÔ∏è The Clock & The Thirst ‚öôÔ∏è</h1>
<p style="text-align:center;color:#9b8fb8;font-style:italic">A Victorian Steampunk Mystery</p>`;

  STATE.completed.forEach((key, i) => {
    const s = SCENES[key];
    if (!s) return;
    html += `<hr><h2>${s.title}</h2>`;
    if (IMAGES[key]) {
      html += `<img class="img" src="${IMAGES[key]}">`;
    }
    if (sections[i]) {
      html += sections[i].split('\n').map(p => p.trim() ? `<p>${p}</p>` : '').join('');
    }
  });

  html += '</body></html>';
  
  const blob = new Blob([html], {type: 'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'clock-thirst.html';
  a.click();
  toast('HTML downloaded');
}

function downloadMD() {
  const prose = document.getElementById('prose').value;
  const md = `# ‚öôÔ∏è The Clock & The Thirst\n\n*A Victorian Steampunk Mystery*\n\n---\n\n${prose}`;
  const blob = new Blob([md], {type: 'text/markdown'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'clock-thirst.md';
  a.click();
  toast('Markdown downloaded');
}

// ============================================
// EVENTS
// ============================================

document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = function() {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    this.classList.add('active');
    document.querySelector(`[data-content="${this.dataset.tab}"]`)?.classList.add('active');
    if (this.dataset.tab === 'illustrations') buildIllustList();
  };
});

document.getElementById('generate-btn').onclick = generatePrompt;
document.getElementById('copy-btn').onclick = () => {
  if (!currentPrompt) { alert('Generate first'); return; }
  navigator.clipboard.writeText(currentPrompt).then(() => toast('‚úì Copied'));
};
document.getElementById('parse-btn').onclick = parseOutput;
document.getElementById('clear-btn').onclick = clearCase;
document.getElementById('download-html').onclick = downloadHTML;
document.getElementById('download-md').onclick = downloadMD;

document.getElementById('prose').onchange = function() {
  localStorage.setItem('clockthirst3_prose', this.value);
};

document.querySelectorAll('.ai-btn').forEach(btn => {
  btn.onclick = function() {
    if (!currentPrompt) { alert('Generate first'); return; }
    const urls = {
      claude: 'https://claude.ai/new',
      gpt: 'https://chat.openai.com/',
      gemini: 'https://gemini.google.com/',
      deepseek: 'https://chat.deepseek.com/'
    };
    navigator.clipboard.writeText(currentPrompt).then(() => {
      window.open(urls[this.dataset.ai], '_blank');
      toast('Prompt copied, opening...');
    });
  };
});

// ============================================
// INIT
// ============================================

async function init() {
  await ImageDB.init();
  IMAGES = await ImageDB.getAll();
  updateUI();
  buildCharList();
  buildIllustList();
}

init();

})();
</script>
</body>
</html>